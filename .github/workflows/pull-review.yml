name: PR Review

on:
  issue_comment:
    types: [created]

jobs:
  review:
    name: Automated PR Review
    if: >-
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/review') &&
      (github.event.comment.author_association == 'MEMBER' ||
      github.event.comment.author_association == 'OWNER' ||
      github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    concurrency:
      group: pr-review-${{ github.event.issue.number }}
      cancel-in-progress: true
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write
      issues: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # â”€â”€ Provider configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Set via Settings â†’ Secrets and variables â†’ Actions â†’ Variables:
      #   REVIEW_PROVIDER: openrouter | zai-coding-plan
      #   REVIEW_MODEL:    stepfun/step-3.5-flash | glm-5
      REVIEW_PROVIDER: ${{ vars.REVIEW_PROVIDER || 'openrouter' }}
      REVIEW_MODEL: ${{ vars.REVIEW_MODEL || 'stepfun/step-3.5-flash' }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}

    steps:
      - name: React to comment
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='eyes'

      - name: Resolve provider settings
        run: |
          case "$REVIEW_PROVIDER" in
            openrouter)
              {
                echo "PROVIDER_API_URL=https://openrouter.ai/api/v1/chat/completions"
                echo "PROVIDER_API_KEY=$OPENROUTER_API_KEY"
                echo "OPENCODE_MODEL=openrouter/$REVIEW_MODEL"
                echo "PROVIDER_DISPLAY=OpenRouter"
                echo "PROVIDER_API_KEY_REF={env:OPENROUTER_API_KEY}"
              } >> "$GITHUB_ENV"
              ;;
            zai-coding-plan)
              {
                echo "PROVIDER_API_URL=https://api.z.ai/api/coding/paas/v4/chat/completions"
                echo "PROVIDER_API_KEY=$ZAI_API_KEY"
                echo "OPENCODE_MODEL=zai-coding-plan/$REVIEW_MODEL"
                echo "PROVIDER_DISPLAY=Z.AI"
                echo "PROVIDER_API_KEY_REF={env:ZAI_API_KEY}"
              } >> "$GITHUB_ENV"
              ;;
            *)
              echo "::error::Unknown REVIEW_PROVIDER '$REVIEW_PROVIDER' (supported: openrouter, zai-coding-plan)"
              exit 1
              ;;
          esac

      - name: Get PR number
        id: pr-info
        run: |
          echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"

      - name: Get PR details
        id: pr-details
        run: |
          gh api "/repos/${{ github.repository }}/pulls/${{ steps.pr-info.outputs.number }}" > pr_data.json
          {
            echo "head_ref=$(jq -r '.head.ref' pr_data.json)"
            echo "head_sha=$(jq -r '.head.sha' pr_data.json)"
            echo "base_ref=$(jq -r '.base.ref' pr_data.json)"
          } >> "$GITHUB_OUTPUT"
          jq -r '.body // ""' pr_data.json > /tmp/pr_body.txt

      - name: Check for linked issue
        id: check-issue
        run: |
          ISSUE_NUM=$(grep -oiP '\b(?:fix(?:es|ed)?|close[sd]?|resolve[sd]?|ref(?:erences?)?|see)\s*#(\d+)' /tmp/pr_body.txt | grep -oP '\d+' | head -1 || true)

          if [ -z "$ISSUE_NUM" ]; then
            echo "has_issue=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_issue=true" >> "$GITHUB_OUTPUT"
            echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"
          fi

      - name: Post missing issue comment
        if: steps.check-issue.outputs.has_issue == 'false'
        run: |
          gh pr comment "${{ steps.pr-info.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --body "$(cat << 'EOF'
          **Automated Review Notice**

          This PR does not appear to have an associated issue. Every PR must have an assigned issue linked in its description.

          Please update the PR description to reference an issue (e.g., `Fixes #123` or `Closes #456`), then comment `/review` to trigger the automated review.
          EOF
          )"

      - name: Checkout repository
        if: steps.check-issue.outputs.has_issue == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.head_sha }}
          fetch-depth: 0

      - name: Merge master into PR branch
        if: steps.check-issue.outputs.has_issue == 'true'
        env:
          BASE_REF: ${{ steps.pr-details.outputs.base_ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin "$BASE_REF"
          git merge "origin/$BASE_REF" --no-edit -m "Merge $BASE_REF for review" || {
            echo "::warning::Merge conflict detected, reviewing PR branch as-is"
            git merge --abort
            git reset --hard HEAD
          }

      - name: Generate diff
        if: steps.check-issue.outputs.has_issue == 'true'
        env:
          BASE_REF: ${{ steps.pr-details.outputs.base_ref }}
        run: |
          git diff "origin/$BASE_REF" -U15 \
            -- . \
            ':!package-lock.json' ':!**/package-lock.json' \
            ':!pnpm-lock.yaml' ':!**/pnpm-lock.yaml' \
            ':!yarn.lock' ':!**/yarn.lock' \
            ':!go.sum' ':!**/go.sum' \
            ':!*.min.js' ':!*.min.css' \
            ':!**/node_modules/**' ':!**/vendor/**' \
            > /tmp/pr_diff.txt

          MAX_CHARS=100000
          DIFF_SIZE=$(wc -c < /tmp/pr_diff.txt)
          if [ "$DIFF_SIZE" -gt "$MAX_CHARS" ]; then
            head -c "$MAX_CHARS" /tmp/pr_diff.txt > /tmp/pr_diff_truncated.txt
            printf '\n\n... [diff truncated â€” %s bytes total, showing first %s]\n' "$DIFF_SIZE" "$MAX_CHARS" >> /tmp/pr_diff_truncated.txt
            mv /tmp/pr_diff_truncated.txt /tmp/pr_diff.txt
          fi

          echo "Diff size: $DIFF_SIZE bytes"

      - name: Fetch issue contents
        if: steps.check-issue.outputs.has_issue == 'true'
        run: |
          if ! gh api "/repos/${{ github.repository }}/issues/${{ steps.check-issue.outputs.issue_number }}" > issue_data.json 2>/dev/null; then
            echo "::warning::Could not fetch issue #${{ steps.check-issue.outputs.issue_number }}"
            echo "Issue context unavailable." > /tmp/issue_context.txt
          else
            {
              echo "## Issue #${{ steps.check-issue.outputs.issue_number }}: $(jq -r '.title // ""' issue_data.json)"
              echo ""
              jq -r '.body // ""' issue_data.json
            } > /tmp/issue_context.txt
          fi

      - name: Build review prompts
        if: steps.check-issue.outputs.has_issue == 'true'
        run: |
          cat > /tmp/raw_prompt.txt << 'PROMPT_END'
          Attached are a set of changes to a JavaScript project that uses StandardJS formatting with Flowtype.

          Please have a look at these changes and thoroughly check it for any bugs or security issues. Also check if anything could be improved through simplification. When providing feedback, be specific and quote the concrete lines that are problematic, and then give your code improvement suggestions complete with actual code. When replying, always use Markdown and Markdown code fences to quote any lines. Avoid commenting on code that has no issues (no "you did a good job here!" fluff).

          When referencing sections of code, always mention the specific lines being referenced in the following manner to make it easy for developers to know where to look:

          - `file.js:841`
          - `file.vue:50-70`

          For each issue you identify, give it a rating of ðŸ”´ for high importance & high confidence, ðŸŸ¡ for medium importance &  high confidence, and âšªï¸ for issues of either lower confidence or lower importance. Prioritize finding ðŸ”´ and ðŸŸ¡ issues. Give your feedback in order of importance from most to least.

          Also, for each issue, immediately after the issue heading please add these two checkboxes:

          - [ ] Addressed
          - [ ] Dismissed

          If no problems are found, state that and do nothing else.

          ### Helpful Context

          PROMPT_END

          {
            cat /tmp/issue_context.txt
            cat << 'SECTION_END'

          ### Changes to Review

          ```diff
          SECTION_END
            cat /tmp/pr_diff.txt
            printf '\n```\n'
          } >> /tmp/raw_prompt.txt

          cat > /tmp/agentic_prompt.txt << 'PROMPT_END'
          Attached are a set of changes to a JavaScript project that uses StandardJS formatting with Flowtype.

          Please have a look at these changes and thoroughly check it for any bugs or security issues. Also check if anything could be improved through simplification. When providing feedback, be specific and quote the concrete lines that are problematic, and then give your code improvement suggestions complete with actual code. When replying, always use Markdown and Markdown code fences to quote any lines. Avoid commenting on code that has no issues (no "you did a good job here!" fluff).

          When referencing sections of code, always mention the specific lines being referenced in the following manner to make it easy for developers to know where to look:

          - `file.js:841`
          - `file.vue:50-70`

          For each issue you identify, give it a rating of ðŸ”´ for high importance & high confidence, ðŸŸ¡ for medium importance & high confidence, and âšªï¸ for issues of either lower confidence or lower importance. Prioritize finding ðŸ”´ and ðŸŸ¡ issues. Give your feedback in order of importance from most to least.

          Also, for each issue, immediately after the issue heading please add these two checkboxes:

          - [ ] Addressed
          - [ ] Dismissed

          You have full access to all of the source code. You can query different parts of the project if you need additional context to help with your review. If you have access to a subagent tool please make use of it when investigating specific questions about the codebase (e.g. "where are all the locations where this function is called?", etc.) to help conserve on tokens. Pay attention to any parts of the project that might break or conflict because of the changes, or any bits that are no longer relevant and should be removed as a result of the changes.

          DO NOT make any edits or modifications to the code! DO NOT modify any files! Just output your review. If no problems are found, state that and do nothing else.

          ### Helpful Context

          PROMPT_END

          {
            cat /tmp/issue_context.txt
            cat << 'SECTION_END'

          ### Changes to Review

          ```diff
          SECTION_END
            cat /tmp/pr_diff.txt
            printf '\n```\n'
          } >> /tmp/agentic_prompt.txt

      - name: Check prompt size
        if: steps.check-issue.outputs.has_issue == 'true'
        id: size-check
        run: |
          MAX_TOKEN_CHARS=260000
          PROMPT_SIZE=$(wc -c < /tmp/raw_prompt.txt)
          echo "Prompt size: $PROMPT_SIZE chars (~$((PROMPT_SIZE / 4)) tokens)"
          if [ "$PROMPT_SIZE" -gt "$MAX_TOKEN_CHARS" ]; then
            echo "too_large=true" >> "$GITHUB_OUTPUT"
          else
            echo "too_large=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post size limit comment
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'true'
        run: |
          PROMPT_SIZE=$(wc -c < /tmp/raw_prompt.txt)
          TOKEN_EST=$((PROMPT_SIZE / 4))
          gh pr comment "${{ steps.pr-info.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --body "**Automated Review Notice**

          This PR exceeds the 260k character limit (~${TOKEN_EST} tokens estimated). The review cannot be performed automatically.

          Please break the PR into smaller pieces, or request a manual review."

      - name: Run raw review
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        run: |
          jq -n \
            --arg model "$REVIEW_MODEL" \
            --rawfile prompt /tmp/raw_prompt.txt \
            '{
              model: $model,
              messages: [{role: "user", content: $prompt}]
            }' > /tmp/raw_payload.json

          HTTP_CODE=$(curl -s -w '%{http_code}' \
            "$PROVIDER_API_URL" \
            -H "Authorization: Bearer $PROVIDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/raw_payload.json \
            -o /tmp/raw_response.json)

          RAW_REVIEW_OK=false
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::warning::Raw review API call failed with HTTP $HTTP_CODE"
            echo "Raw review unavailable (API returned HTTP $HTTP_CODE)." > /tmp/raw_review.txt
          elif jq -e '.choices[0].message.content' /tmp/raw_response.json > /dev/null 2>&1; then
            jq -r '.choices[0].message.content' /tmp/raw_response.json > /tmp/raw_review.txt
            RAW_REVIEW_OK=true
          else
            echo "::warning::Raw review returned unexpected response"
            echo "Raw review unavailable (unexpected API response)." > /tmp/raw_review.txt
          fi

          echo "Raw review complete ($(wc -c < /tmp/raw_review.txt) bytes)"
          echo "RAW_REVIEW_OK=${RAW_REVIEW_OK:-false}" >> "$GITHUB_ENV"

      - name: Install opencode
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Configure opencode
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        run: |
          mkdir -p ~/.config/opencode
          jq -n \
            --arg provider "$REVIEW_PROVIDER" \
            --arg api_key_ref "$PROVIDER_API_KEY_REF" \
            '{
              "$schema": "https://opencode.ai/config.json",
              "provider": {
                ($provider): {
                  "options": { "apiKey": $api_key_ref }
                }
              }
            }' > ~/.config/opencode/opencode.json

      - name: Run agentic review
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        env:
          OPENCODE_PERMISSION: '{ "edit": "deny", "write": "deny", "patch": "deny", "multiedit": "deny", "bash": "deny", "read": "allow", "grep": "allow", "glob": "allow", "list": "allow" }'
        run: |
          opencode run -m "$OPENCODE_MODEL" < /tmp/agentic_prompt.txt > /tmp/agentic_review.txt 2>/tmp/opencode_stderr.txt || {
            echo "::warning::Agentic review via opencode failed"
            cat /tmp/opencode_stderr.txt >&2
            echo "Agentic review unavailable (opencode encountered an error)." > /tmp/agentic_review.txt
          }

          echo "Agentic review complete ($(wc -c < /tmp/agentic_review.txt) bytes)"

      - name: Combine reviews
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        run: |
          cat > /tmp/combine_prompt.txt << 'COMBINE_HEADER'
          You are given two code reviews of the same PR. Combine them into a single comprehensive review:

          1. De-duplicate issues that appear in both reviews (keep the better description)
          2. Sort all issues by priority: ðŸ”´ (high importance & high confidence) first, then ðŸŸ¡ (medium), then âšªï¸ (low)
          3. Keep the rating and checkbox format for each issue
          4. Preserve specific code references (file:line) and code suggestions
          5. Do not place a header like `# Combined Code Review` at the top of the review, just immediately output the issues (if there are any)
          6. If there are no issues, state that and do nothing else.

          Output ONLY the combined review in Markdown. No preamble about the combining process.

          ---

          ## Raw Review

          COMBINE_HEADER

          {
            cat /tmp/raw_review.txt
            cat << 'COMBINE_SEPARATOR'

          ---

          ## Agentic Review

          COMBINE_SEPARATOR
            cat /tmp/agentic_review.txt
          } >> /tmp/combine_prompt.txt

          jq -n \
            --arg model "$REVIEW_MODEL" \
            --rawfile prompt /tmp/combine_prompt.txt \
            '{
              model: $model,
              messages: [{role: "user", content: $prompt}]
            }' > /tmp/combine_payload.json

          HTTP_CODE=$(curl -s -w '%{http_code}' \
            "$PROVIDER_API_URL" \
            -H "Authorization: Bearer $PROVIDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/combine_payload.json \
            -o /tmp/combine_response.json)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::warning::Combine step failed with HTTP $HTTP_CODE, falling back to raw review"
            cp /tmp/raw_review.txt /tmp/final_review.txt
            if [ "$RAW_REVIEW_OK" = "true" ]; then
              echo "REVIEW_TYPE=Raw" >> "$GITHUB_ENV"
            else
              echo "REVIEW_TYPE=Error" >> "$GITHUB_ENV"
            fi
          elif jq -e '.choices[0].message.content' /tmp/combine_response.json > /dev/null 2>&1; then
            jq -r '.choices[0].message.content' /tmp/combine_response.json > /tmp/final_review.txt
            echo "REVIEW_TYPE=Combined" >> "$GITHUB_ENV"
          else
            echo "::warning::Combine step returned unexpected response, falling back to raw review"
            cp /tmp/raw_review.txt /tmp/final_review.txt
            if [ "$RAW_REVIEW_OK" = "true" ]; then
              echo "REVIEW_TYPE=Raw" >> "$GITHUB_ENV"
            else
              echo "REVIEW_TYPE=Error" >> "$GITHUB_ENV"
            fi
          fi

      - name: Post review comment
        if: steps.check-issue.outputs.has_issue == 'true' && steps.size-check.outputs.too_large == 'false'
        run: |
          {
            echo "## Advanced AI Review"
            echo ""
            echo "- Type: ${REVIEW_TYPE}"
            echo "- Model: ${REVIEW_MODEL}"
            echo ""
            echo "<details>"
            echo "<summary>Click to expand review</summary>"
            echo ""
            cat /tmp/final_review.txt
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo "*Review generated using \`${REVIEW_MODEL}\` via ${PROVIDER_DISPLAY}. Comment \`/review\` to re-run.*"
          } > /tmp/review_comment.txt

          gh pr comment "${{ steps.pr-info.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --body-file /tmp/review_comment.txt
